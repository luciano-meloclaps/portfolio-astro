---
// src/components/modules/MobileMenu.astro
import Links from '@/components/ui/Links.astro';
import { IconX } from '@tabler/icons-react';
---

<div
  id="mobile-menu-container"
  class="pointer-events-none fixed inset-0 z-[999] opacity-0"
  aria-hidden="true"
  style="visibility: hidden;"
>
  <!-- Fondo sólido -->
  <div id="mobile-menu-overlay" class="absolute inset-0 bg-background"></div>

  <!-- 
    BOTÓN DE CIERRE (ESTILO PROJECT CARD)
    - bg-background/20: Vidrio sutil.
    - backdrop-blur-md: Desenfoque.
    - border-border: Borde consistente.
    - rounded-small: Forma técnica.
  -->
  <button
    id="mobile-menu-close-btn"
    class="bg-background/20 hover:bg-background/40 text-secondary decorative-elem group pointer-events-auto absolute right-6 top-6 z-50 cursor-pointer rounded-small border border-border p-2 text-text-primary backdrop-blur-md transition-all duration-300 active:scale-95"
    aria-label="Cerrar menú"
  >
    <IconX
      className="h-6 w-6 transition-transform duration-300 group-hover:rotate-90"
      strokeWidth={1.0}
    />
  </button>

  <!-- Contenido -->
  <div class="relative z-10 flex h-full flex-col justify-start px-8 pt-32">
    <div class="border-text-primary/20 decorative-elem mb-8 w-full border-t">
    </div>

    <!-- Título traducido -->
    <h4
      class="decorative-elem mb-8 font-mono text-xs uppercase tracking-widest text-text-secondary"
    >
      Navegación
    </h4>

    <div class="pointer-events-auto w-full">
      <Links
        ulClass="flex-col !gap-y-6 nav-links-mobile w-full text-left !items-start"
        aClass="!text-3xl !font-light tracking-tight hover:text-accent-magenta transition-colors"
      />
    </div>
  </div>
</div>

<script>
  import gsap from 'gsap';

  function initMobileMenu() {
    const container = document.getElementById('mobile-menu-container');
    const overlay = document.getElementById('mobile-menu-overlay');
    const closeBtn = document.getElementById('mobile-menu-close-btn');

    if (!container || !overlay) return;

    const decorativeElements = container.querySelectorAll('.decorative-elem');
    const links = gsap.utils.toArray('.nav-links-mobile li') as HTMLElement[];

    // Configuración Inicial
    gsap.set(container, { autoAlpha: 0 });
    gsap.set(links, { y: 20, opacity: 0 });
    if (decorativeElements.length > 0) {
      gsap.set(decorativeElements, { opacity: 0 });
    }

    const tl = gsap.timeline({ paused: true });

    // ANIMACIÓN ACELERADA (Snappy)
    tl.to(container, { duration: 0.25, autoAlpha: 1, ease: 'power2.out' })
      .to(
        decorativeElements,
        { duration: 0.3, opacity: 1, ease: 'power2.out' },
        '-=0.1'
      )
      .to(
        links,
        {
          duration: 0.2, // Más rápido (antes 0.3)
          opacity: 1,
          y: 0,
          stagger: 0.05, // Cascada más rápida (antes 0.1)
          ease: 'power3.out',
        },
        '-=0.15'
      );

    let isMenuOpen = false;

    const openMenu = () => {
      if (isMenuOpen) return;
      isMenuOpen = true;

      container.classList.remove('pointer-events-none');
      container.classList.add('pointer-events-auto');
      container.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';

      tl.timeScale(1).play();
    };

    const closeMenu = () => {
      if (!isMenuOpen) return;
      isMenuOpen = false;

      container.classList.remove('pointer-events-auto');
      container.classList.add('pointer-events-none');
      container.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';

      tl.timeScale(2.5).reverse();
      document.dispatchEvent(new CustomEvent('menu-closed'));
    };

    const toggleHandler = () => {
      isMenuOpen ? closeMenu() : openMenu();
    };

    document.removeEventListener('toggle-menu', toggleHandler);
    document.addEventListener('toggle-menu', toggleHandler);

    overlay.addEventListener('click', closeMenu);

    links.forEach((link) => {
      link.addEventListener('click', closeMenu);
    });

    if (closeBtn) {
      closeBtn.onclick = (e) => {
        e.stopPropagation();
        closeMenu();
      };
    }
  }

  document.addEventListener('astro:page-load', initMobileMenu);
  document.addEventListener('DOMContentLoaded', initMobileMenu);
</script>
