---
// src/components/ui/CertificationCard.astro
import type { CollectionEntry } from 'astro:content';
import Card from '@/components/ui/Card.astro';
import ChipTech from '@/components/ui/ChipTech.astro';
import CategoryBadge from '@/components/ui/CategoryBadge.astro';
import { techIconMap } from '@/config/tech-icon-map';
import {
  IconCertificate,
  IconCalendar,
  IconExternalLink,
  IconPointFilled,
  IconChevronDown,
} from '@tabler/icons-react';

interface Props {
  certification: CollectionEntry<'certifications'>;
}

const { certification } = Astro.props;
const {
  title,
  issuer,
  category,
  issueDate,
  expiryDate,
  description,
  keySkills,
  techStack,
  credentialId,
  credentialUrl,
} = certification.data;

const formatDate = (date: Date) => new Date(date).getFullYear();
// Generamos un ID único para accesibilidad (ARIA)
const uniqueId = `cert-${title.toLowerCase().replace(/\s+/g, '-')}-${credentialId || Math.random().toString(36).substr(2, 9)}`;
---

<div class="certification-card-wrapper group">
  <Card
    padding="none"
    class="relative overflow-hidden border border-border bg-panel"
  >
    <div class="halo-effect"></div>
    <div class="relative z-10 flex flex-col p-6">
      <!-- Header -->
      <div class="flex items-center justify-between">
        <div
          class="text-text-secondary/70 text-s flex items-center gap-x-2 font-bold uppercase tracking-wider"
        >
          <IconCertificate className="h-4 w-4" strokeWidth={1.0} />
          <span>{issuer}</span>
        </div>
        {
          credentialUrl && (
            <a
              href={credentialUrl}
              target="_blank"
              class="text-text-secondary transition-colors hover:text-text-primary"
              aria-label="Ver credencial"
            >
              <IconExternalLink className="h-5 w-5" strokeWidth={1.0} />
            </a>
          )
        }
      </div>

      <!-- Main Content -->
      <div class="mt-3">
        <h3 class="text-xl font-bold leading-tight text-text-primary">
          {title}
        </h3>
        <div class="mt-4 flex flex-wrap items-center gap-4">
          <CategoryBadge category={category} />
          <div
            class="flex items-center gap-x-1.5 font-mono text-xs text-text-secondary"
          >
            <IconCalendar className="h-3.5 w-3.5" />
            <span
              >{formatDate(issueDate)} - {
                expiryDate ? formatDate(expiryDate) : 'Indefinido'
              }</span
            >
          </div>
        </div>
        <p class="mt-4 text-sm font-light leading-relaxed text-text-secondary">
          {description}
        </p>
      </div>

      <!-- Toggle Button (Accessible) -->
      <button
        id={`btn-${uniqueId}`}
        aria-controls={`content-${uniqueId}`}
        aria-expanded="false"
        class="details-toggle border-border/50 group/btn mt-6 flex w-full cursor-pointer items-center justify-between border-t pt-4 text-xs font-bold uppercase tracking-wider text-text-secondary transition-colors hover:text-text-primary"
      >
        <span>Detalles Técnicos</span>
        <IconChevronDown
          className="h-4 w-4 transition-transform duration-300 group-hover/btn:translate-y-0.5"
        />
      </button>

      <!-- Collapsible Content -->
      <div
        id={`content-${uniqueId}`}
        class="details-container max-h-0 overflow-hidden"
        role="region"
        aria-labelledby={`btn-${uniqueId}`}
      >
        <div class="details-content pt-4">
          <!-- Skills -->
          <div>
            <h4
              class="text-text-secondary/60 mb-3 font-sans text-[10px] font-bold uppercase tracking-widest"
            >
              Competencias Clave
            </h4>
            <ul class="grid grid-cols-1 gap-2 sm:grid-cols-2">
              {
                keySkills.map((skill) => (
                  <li class="flex items-start gap-x-2">
                    <IconPointFilled className="h-3 w-3 flex-shrink-0 text-accent-magenta mt-1" />
                    <span class="text-xs text-text-secondary">{skill}</span>
                  </li>
                ))
              }
            </ul>
          </div>
          <!-- Tech Stack -->
          {
            techStack && techStack.length > 0 && (
              <div class="border-border/30 mt-5 border-t pt-4">
                <h4 class="text-text-secondary/60 mb-3 font-sans text-[10px] font-bold uppercase tracking-widest">
                  Tecnologías
                </h4>
                <div class="flex flex-wrap gap-2">
                  {techStack.map((tech) => {
                    const Icon = techIconMap[tech.toLowerCase()];
                    return Icon ? <ChipTech Icon={Icon} name={tech} /> : null;
                  })}
                </div>
              </div>
            )
          }
        </div>
      </div>
    </div>
  </Card>
</div>

<script>
  import gsap from 'gsap';

  // Función de inicialización para soportar View Transitions en el futuro
  function initCertCards() {
    document
      .querySelectorAll('.certification-card-wrapper')
      .forEach((cardWrapper) => {
        const toggle = cardWrapper.querySelector('.details-toggle');
        const container = cardWrapper.querySelector('.details-container');
        const content = cardWrapper.querySelector('.details-content');
        const chevron = cardWrapper.querySelector('.details-toggle svg');

        if (!toggle || !container || !content || !chevron) return;

        // Evitamos re-inicializar si ya tiene listeners (buena práctica en SPAs)
        if (toggle.hasAttribute('data-initialized')) return;
        toggle.setAttribute('data-initialized', 'true');

        let isVisible = false;

        toggle.addEventListener('click', (e) => {
          e.stopPropagation();
          isVisible = !isVisible;

          // Actualizamos ARIA
          toggle.setAttribute('aria-expanded', String(isVisible));

          // Animación GSAP
          if (isVisible) {
            gsap.to(container, {
              maxHeight: content.scrollHeight,
              duration: 0.4,
              ease: 'power2.out',
            });
            gsap.to(chevron, { rotation: 180, duration: 0.0 });
          } else {
            gsap.to(container, {
              maxHeight: 0,
              duration: 0.3,
              ease: 'power2.in',
            });
            gsap.to(chevron, { rotation: 0, duration: 0.0 });
          }
        });
      });
  }

  // Ejecutar en carga inicial
  initCertCards();

  // Si usas View Transitions de Astro, descomenta la siguiente línea:
  document.addEventListener('astro:page-load', initCertCards);
</script>
