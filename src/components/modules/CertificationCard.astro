---
// src/components/ui/CertificationCard.astro
import type { CollectionEntry } from 'astro:content';
import Card from '@/components/ui/Card.astro';
import TechChip from '@/components/ui/TechChip.astro';
import CategoryBadge from '@/components/ui/CategoryBadge.astro';
import { techIconMap } from '@/config/tech-icon-map';
import { normalizeTechName } from '@/lib/normalizeTech';
import {
  IconCertificate,
  IconCalendar,
  IconExternalLink,
  IconPointFilled,
  IconChevronDown,
} from '@tabler/icons-react';

interface Props {
  certification: CollectionEntry<'certifications'>;
}

const { certification } = Astro.props;
const {
  title,
  issuer,
  category,
  issueDate,
  description,
  keySkills,
  techStack,
  credentialId,
  credentialUrl,
} = certification.data;

// FIX: Solo mostramos el año de emisión
const year = new Date(issueDate).getFullYear();
const uniqueId = `cert-${title.toLowerCase().replace(/\s+/g, '-')}-${credentialId || Math.random().toString(36).substr(2, 9)}`;
---

<!-- 
  WRAPPER: h-full para que ocupe toda la altura de la celda del grid 
-->
<div class="certification-card-wrapper group h-full">
  <Card
    padding="none"
    class="hover:border-accent-magenta/40 relative flex h-full flex-col overflow-hidden border border-border bg-background shadow-sm transition-all duration-300 hover:shadow-lg"
  >
    <div class="halo-effect pointer-events-none"></div>

    <!-- CONTENIDO FLEXIBLE -->
    <div class="relative z-10 flex h-full flex-col p-6">
      <!-- Header -->
      <div class="mb-4 flex items-center justify-between">
        <div
          class="text-text-secondary/70 flex items-center gap-x-2 text-xs font-bold uppercase tracking-wider"
        >
          <IconCertificate className="h-4 w-4" strokeWidth={1.0} />
          <span>{issuer}</span>
        </div>
        {
          credentialUrl && (
            <a
              href={credentialUrl}
              target="_blank"
              class="text-text-secondary transition-colors hover:text-text-primary"
              aria-label="Ver credencial"
            >
              <IconExternalLink className="h-5 w-5" strokeWidth={1.0} />
            </a>
          )
        }
      </div>

      <!-- Título y Badges -->
      <div class="mb-4">
        <h3
          class="mb-3 flex min-h-[3.5rem] items-center text-xl font-bold leading-tight text-text-primary"
        >
          {title}
        </h3>
        <div class="flex flex-wrap items-center gap-4">
          <CategoryBadge category={category} />
          <div
            class="flex items-center gap-x-1.5 font-mono text-xs text-text-secondary"
          >
            <IconCalendar className="h-3.5 w-3.5" />
            <span>{year}</span>
          </div>
        </div>
      </div>

      <!-- 
        DESCRIPCIÓN (FLEX GROW)
        Esto empuja el botón de "Detalles" hacia abajo, alineándolos todos visualmente.
      -->
      <div class="flex-grow">
        <p
          class="line-clamp-3 text-sm font-light leading-relaxed text-text-secondary"
        >
          {description}
        </p>
      </div>

      <!-- Toggle Button (Siempre abajo) -->
      <button
        id={`btn-${uniqueId}`}
        aria-controls={`content-${uniqueId}`}
        aria-expanded="false"
        class="details-toggle group/btn mt-6 flex w-full cursor-pointer items-center justify-between border-t border-border pt-4 text-xs font-bold uppercase tracking-wider text-text-secondary transition-colors hover:text-text-primary"
      >
        <span>Detalles Técnicos</span>
        <IconChevronDown
          className="h-4 w-4 transition-transform duration-300 group-hover/btn:translate-y-0.5"
        />
      </button>

      <!-- Collapsible Content -->
      <div
        id={`content-${uniqueId}`}
        class="details-container max-h-0 overflow-hidden"
        role="region"
        aria-labelledby={`btn-${uniqueId}`}
      >
        <div class="details-content pt-4">
          <!-- Skills -->
          <div>
            <h4
              class="text-text-secondary/60 mb-3 font-sans text-[10px] font-bold uppercase tracking-widest"
            >
              Competencias Clave
            </h4>
            <ul class="grid grid-cols-1 gap-2 sm:grid-cols-2">
              {
                keySkills.map((skill) => (
                  <li class="flex items-start gap-x-2">
                    <IconPointFilled className="h-3 w-3 flex-shrink-0 text-text-primary mt-1" />
                    <span class="text-xs text-text-secondary">{skill}</span>
                  </li>
                ))
              }
            </ul>
          </div>
          <!-- Tech Stack -->
          {
            techStack && techStack.length > 0 && (
              <div class="mt-5 border-t border-border pt-4">
                <h4 class="text-text-secondary/60 mb-3 font-sans text-[10px] font-bold uppercase tracking-widest">
                  Tecnologías
                </h4>
                <div class="flex flex-wrap gap-2">
                  {techStack.map((tech) => {
                    const normalizedTech = normalizeTechName(tech);
                    const Icon = techIconMap[normalizedTech];
                    return Icon ? (
                      <TechChip
                        Icon={Icon}
                        name={normalizedTech}
                        label={tech}
                        mode="static"
                      />
                    ) : null;
                  })}
                </div>
              </div>
            )
          }
        </div>
      </div>
    </div>
  </Card>
</div>

<script>
  import gsap from 'gsap';

  function initCertCards() {
    document
      .querySelectorAll('.certification-card-wrapper')
      .forEach((cardWrapper) => {
        const toggle = cardWrapper.querySelector('.details-toggle');
        const container = cardWrapper.querySelector('.details-container');
        const content = cardWrapper.querySelector('.details-content');
        const chevron = cardWrapper.querySelector('.details-toggle svg');

        if (!toggle || !container || !content || !chevron) return;

        if (toggle.hasAttribute('data-initialized')) return;
        toggle.setAttribute('data-initialized', 'true');

        let isVisible = false;

        toggle.addEventListener('click', (e) => {
          e.stopPropagation();
          isVisible = !isVisible;
          toggle.setAttribute('aria-expanded', String(isVisible));

          if (isVisible) {
            gsap.to(container, {
              maxHeight: content.scrollHeight,
              duration: 0.4,
              ease: 'power2.out',
            });
            gsap.to(chevron, { rotation: 180, duration: 0.3 });
          } else {
            gsap.to(container, {
              maxHeight: 0,
              duration: 0.3,
              ease: 'power2.in',
            });
            gsap.to(chevron, { rotation: 0, duration: 0.3 });
          }
        });
      });
  }

  document.addEventListener('astro:page-load', initCertCards);
  document.addEventListener('DOMContentLoaded', initCertCards);
</script>
