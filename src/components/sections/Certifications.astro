---
// src/components/sections/Certifications.astro
import { getCollection } from 'astro:content';
import CertificationCard from '@/components/modules/CertificationCard.astro';
import SectionTitle from '@/components/ui/SectionTitle.astro';
import TechChip from '@/components/ui/TechChip.astro';
import Button from '@/components/ui/Button.astro'; // ⚡ Import
import { IconChevronDown } from '@tabler/icons-react';
import { techIconMap } from '@/config/tech-icon-map';

const allCertifications = await getCollection('certifications');
allCertifications.sort(
  (a, b) => b.data.issueDate.valueOf() - a.data.issueDate.valueOf()
);

const usedCategories = Array.from(
  new Set(allCertifications.map((cert) => cert.data.category))
).sort();

const INITIAL_CERT_LIMIT = 4;
---

<section id="certifications" class="relative py-24 md:py-32">
  <div class="container-narrow certifications-section-content space-y-16">
    <div class="flex w-full flex-col items-center justify-center">
      <SectionTitle
        title="Certificados"
        subtitle="Credenciales técnicas que validan mi expertise."
        class="items-center text-center"
      />
    </div>

    {
      usedCategories.length > 0 && (
        <div class="filter-bar-wrapper space-y-4">
          <label class="block font-mono text-sm font-light uppercase tracking-normal text-text-secondary">
            Filtrar por:
          </label>
          <div
            id="cert-filter-container"
            class="filter-chips-container flex flex-wrap gap-2 sm:gap-3"
            role="group"
            data-filter-section="certifications"
          >
            <TechChip
              Icon={null}
              name="all"
              label="Todos"
              mode="filter"
              data-filter-name="all"
              data-filter-label="Todos"
              data-filter-active="true"
              aria-pressed="true"
              class="cert-filter-btn"
            />
            {usedCategories.map((category) => {
              const normalizedCategory = category.toLowerCase();
              const Icon = techIconMap[normalizedCategory] || null;
              return (
                <TechChip
                  Icon={Icon}
                  name={normalizedCategory}
                  label={category}
                  mode="filter"
                  data-filter-name={normalizedCategory}
                  data-filter-label={category}
                  data-filter-active="false"
                  aria-pressed="false"
                  class="cert-filter-btn"
                />
              );
            })}
          </div>
          <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
            <span
              id="cert-filter-counter-text"
              class="font-mono text-xs uppercase tracking-wide text-text-secondary"
            >
              Mostrando todas las certificaciones
            </span>
            <button
              id="cert-filter-clear-btn"
              class="hidden cursor-pointer font-mono text-xs uppercase tracking-wide text-text-secondary hover:text-text-primary"
            >
              Limpiar filtros
            </button>
          </div>
          <div
            class="h-px bg-border/50 opacity-0 transition-opacity duration-300"
            id="cert-filter-line"
          />
        </div>
      )
    }

    <div id="certifications-grid" class="grid grid-cols-1 gap-8 md:grid-cols-2">
      {
        allCertifications.map((cert, index) => {
          const isHidden = index >= INITIAL_CERT_LIMIT;
          return (
            <div
              class={`certification-card-wrapper ${isHidden ? 'hidden-by-cert-pagination hidden' : ''}`}
              data-certification-slug={cert.slug}
              data-category={cert.data.category}
            >
              <CertificationCard certification={cert} />
            </div>
          );
        })
      }
    </div>

    <!-- ⚡ BOTÓN VER MÁS (REDISEÑADO) -->
    {
      allCertifications.length > INITIAL_CERT_LIMIT && (
        <div class="mt-12 flex justify-center" id="load-more-certs-container">
          <div id="load-more-certs-trigger">
            <Button variant="secondary" class="group min-w-[200px]">
              Ver Más Certificados
              <IconChevronDown className="w-4 h-4 transition-transform duration-300 group-hover:translate-y-1" />
            </Button>
          </div>
        </div>
      )
    }
  </div>
</section>

<script>
  import gsap from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';
  gsap.registerPlugin(ScrollTrigger);

  let filterTimeline: gsap.core.Timeline | null = null;

  function initCertFilterBar() {
    const container = document.getElementById('cert-filter-container');
    if (!container) return;

    const filterLine = document.getElementById('cert-filter-line');
    const counterText = document.getElementById('cert-filter-counter-text');
    const clearBtn = document.getElementById('cert-filter-clear-btn');
    const filterBtns = Array.from(
      container.querySelectorAll('.cert-filter-btn')
    ) as HTMLElement[];

    // Paginación Refs
    const loadMoreBtn = document.getElementById('load-more-certs-trigger');
    const loadMoreContainer = document.getElementById(
      'load-more-certs-container'
    );
    const STEP = 4;

    function applyFilter(activeFilterName: string) {
      const wrappers = Array.from(
        document.querySelectorAll('.certification-card-wrapper')
      ) as HTMLElement[];

      if (filterTimeline) filterTimeline.kill();
      // ⚡ ORION SPEED: 0.2s
      filterTimeline = gsap.timeline({
        defaults: { duration: 0.2, ease: 'power2.out' },
      });

      const wrappersToShow: HTMLElement[] = [];
      const wrappersToHide: HTMLElement[] = [];

      if (loadMoreContainer) {
        if (activeFilterName !== 'all') {
          loadMoreContainer.style.display = 'none';
        } else {
          const remaining = document.querySelectorAll(
            '.hidden-by-cert-pagination'
          ).length;
          loadMoreContainer.style.display = remaining > 0 ? '' : 'none';
        }
      }

      wrappers.forEach((wrapper) => {
        if (
          activeFilterName === 'all' &&
          wrapper.classList.contains('hidden-by-cert-pagination')
        ) {
          wrappersToHide.push(wrapper);
          return;
        }

        const cardCategory = wrapper.getAttribute('data-category') || '';
        const show =
          activeFilterName === 'all' ||
          cardCategory.toLowerCase() === activeFilterName;

        if (show) wrappersToShow.push(wrapper);
        else wrappersToHide.push(wrapper);
      });

      wrappersToHide.forEach((el) => {
        filterTimeline!.to(
          el,
          {
            opacity: 0,
            scale: 0.95,
            duration: 0.15,
            onComplete: () => {
              el.classList.add('hidden');
              el.style.display = 'none';
            },
          },
          0
        );
      });
      wrappersToShow.forEach((el) => {
        el.classList.remove('hidden');
        el.style.display = '';
        filterTimeline!.to(el, { opacity: 1, scale: 1, duration: 0.2 }, 0);
      });

      if (filterLine) {
        gsap.to(filterLine, {
          opacity: activeFilterName !== 'all' ? 1 : 0,
          duration: 0.3,
        });
      }
    }

    // --- LÓGICA VER MÁS (TURBO) ---
    loadMoreBtn?.addEventListener('click', () => {
      const hiddenWrappers = document.querySelectorAll(
        '.hidden-by-cert-pagination'
      );
      let count = 0;
      hiddenWrappers.forEach((wrapper) => {
        if (count < STEP) {
          wrapper.classList.remove('hidden', 'hidden-by-cert-pagination');
          const el = wrapper as HTMLElement;
          el.style.opacity = '0';
          el.style.transform = 'translateY(15px)';
          el.style.display = '';

          gsap.to(el, {
            opacity: 1,
            y: 0,
            duration: 0.3,
            ease: 'power2.out',
            delay: count * 0.05,
          });
          count++;
        }
      });
      if (
        document.querySelectorAll('.hidden-by-cert-pagination').length === 0 &&
        loadMoreContainer
      ) {
        gsap.to(loadMoreContainer, {
          opacity: 0,
          height: 0,
          margin: 0,
          duration: 0.3,
          onComplete: () => {
            loadMoreContainer.style.display = 'none';
          },
        });
      }
    });

    // --- ACTUALIZAR UI ---
    const updateUI = () => {
      const activeBtnElement = container!.querySelector(
        '[data-filter-active="true"]'
      );
      const activeFilterName =
        activeBtnElement?.getAttribute('data-filter-name') || 'all';

      if (counterText) {
        if (activeFilterName === 'all')
          counterText.textContent = 'Mostrando todas las certificaciones';
        else {
          const activeLabel =
            activeBtnElement?.getAttribute('data-filter-label') ||
            activeFilterName;
          counterText.textContent = `FILTRO ACTIVO: ${activeLabel}`;
        }
      }
      if (clearBtn)
        clearBtn.classList.toggle('hidden', activeFilterName === 'all');
      applyFilter(activeFilterName);
    };

    filterBtns.forEach((btn) => {
      btn.addEventListener('click', () => {
        const filterName = btn.getAttribute('data-filter-name');
        if (!filterName) return;
        filterBtns.forEach((b) => {
          b.setAttribute('data-filter-active', 'false');
          b.setAttribute('aria-pressed', 'false');
        });
        btn.setAttribute('data-filter-active', 'true');
        btn.setAttribute('aria-pressed', 'true');
        updateUI();
      });
    });

    if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        const allBtn = filterBtns.find(
          (btn) => btn.getAttribute('data-filter-name') === 'all'
        );
        if (allBtn) allBtn.click();
      });
    }
  }

  // --- SCROLL ANIMATION (TURBO) ---
  function initScrollAnimation() {
    const section = document.querySelector('.certifications-section-content');
    if (!section) return;
    const cards = gsap.utils.toArray(
      '.certification-card-wrapper:not(.hidden)'
    );
    gsap.set(cards, { autoAlpha: 0, y: 30 }); // Menos distancia Y

    ScrollTrigger.create({
      trigger: section,
      start: 'top 75%', // Dispara un poco antes
      onEnter: () => {
        gsap.to(cards, {
          autoAlpha: 1,
          y: 0,
          duration: 0.6,
          stagger: 0.05,
          ease: 'power2.out',
        });
      },
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    initCertFilterBar();
    initScrollAnimation();
  });
  document.addEventListener('astro:page-load', () => {
    initCertFilterBar();
  });
  document.addEventListener('astro:before-swap', () => {
    if (filterTimeline) filterTimeline.kill();
  });
</script>
