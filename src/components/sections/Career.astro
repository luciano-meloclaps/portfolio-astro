---
// src/sections/Career.astro
import { getCollection, type CollectionEntry } from 'astro:content';
import ExperienceCard from '@/components/modules/ExperienceCard.astro';
import SectionTitle from '@/components/ui/SectionTitle.astro';

const allCareerItems: CollectionEntry<'career'>[] =
  await getCollection('career');
allCareerItems.sort(
  (a, b) => b.data.startDate.valueOf() - a.data.startDate.valueOf()
);
---

<section id="experience" class="py-24 md:py-32">
  <div class="container-narrow career-section-content space-y-16">
    <SectionTitle
      title="TRAYECTORIA"
      subtitle="El camino recorrido: formación, trabajos y evolución profesional."
    />

    <div class="relative">
      <div
        class="timeline-line absolute bottom-4 left-1/2 top-4 w-px -translate-x-1/2 bg-border"
      >
      </div>

      <div class="space-y-16">
        {
          allCareerItems.map((item, index) => (
            <div class="timeline-item relative flex items-center">
              <div class="timeline-node absolute left-1/2 h-3 w-3 -translate-x-1/2 rounded-full border-2 border-border bg-background" />
              <div
                class:list={[
                  'w-full px-4 md:w-[calc(50%-2rem)]',
                  {
                    'md:ml-auto md:pl-0': index % 2 !== 0,
                    'md:pr-0': index % 2 === 0,
                  },
                ]}
              >
                <ExperienceCard experience={item} />
              </div>
            </div>
          ))
        }
      </div>
    </div>
  </div>
</section>

<script>
  import gsap from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';
  gsap.registerPlugin(ScrollTrigger);

  function initCareerAnimation() {
    const section = document.querySelector('.career-section-content');
    if (!section) return;

    const line = section.querySelector('.timeline-line') as HTMLElement;
    const items = gsap.utils.toArray('.timeline-item') as HTMLElement[];

    gsap.set([line, ...items], { autoAlpha: 0 });

    const tl = gsap.timeline({
      scrollTrigger: {
        trigger: section,
        start: 'top 60%',
      },
    });

    tl.to(line, {
      autoAlpha: 1,
      scaleY: 1,
      duration: 1.5,
      from: { scaleY: 0 },
      ease: 'power2.out',
    }).to(
      items,
      { autoAlpha: 1, y: 0, stagger: 0.3, from: { y: 50 }, ease: 'power3.out' },
      '-=1.0'
    );
  }

  document.addEventListener('astro:page-load', initCareerAnimation);
  document.addEventListener('DOMContentLoaded', initCareerAnimation);
</script>
