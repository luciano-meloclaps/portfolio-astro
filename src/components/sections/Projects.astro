---
// src/components/sections/Projects.astro
import { getCollection } from 'astro:content';
import ProjectThumbnailCard from '../modules/ProjectThumbnailCard.astro';
import ProjectCard from '../modules/ProjectCard.astro';
import SectionTitle from '@/components/ui/SectionTitle.astro';
import FilterBar from '@/components/ui/FilterBar.astro';

import { PROJECT_FILTERS } from '@/config/filter-list';
import { normalizeTechName } from '@/lib/normalizeTech';

const allProjects = await getCollection('projects');
allProjects.sort(
  (a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf()
);

const usedTechsInProjects = new Set(
  allProjects
    .flatMap((p) => p.data.techStack ?? [])
    .filter((t): t is string => typeof t === 'string' && t.length > 0)
    .map((t) => normalizeTechName(t))
);

const activeFilters = PROJECT_FILTERS.filter((tech) =>
  usedTechsInProjects.has(tech)
);
---

<section id="projects" class="relative py-24 md:py-32">
  <div class="container-narrow projects-section-content space-y-16">
    <div class="flex w-full flex-col items-center justify-center">
      <SectionTitle
        title="Proyectos"
        subtitle="Código en funcionamiento. Soluciones reales a problemas reales."
        class="items-center text-center"
      />
    </div>

    {
      activeFilters.length > 0 && (
        <div class="filter-bar-wrapper">
          <FilterBar availableTechs={activeFilters} sectionId="projects" />
        </div>
      )
    }

    <div id="projects-grid" class="grid grid-cols-1 gap-8 md:grid-cols-2">
      {
        allProjects.map((project, index) => (
          <ProjectThumbnailCard project={project} index={index} />
        ))
      }
    </div>
  </div>

  <!-- OVERLAY MODAL -->
  <div
    id="project-overlay"
    class="pointer-events-none fixed inset-0 z-[9999] opacity-0"
    aria-hidden="true"
  >
    <div
      class="bg-background/95 absolute inset-0 backdrop-blur-sm transition-opacity duration-300"
      id="overlay-bg"
    >
    </div>

    <div
      class="no-scrollbar fixed inset-0 overflow-y-auto overscroll-contain"
      style="-webkit-overflow-scrolling: touch;"
    >
      <div
        class="flex min-h-full items-center justify-center p-4 text-center sm:p-6"
      >
        {
          allProjects.map((project) => (
            <div
              class="project-detail-wrapper relative hidden w-full max-w-5xl text-left"
              data-slug={project.slug}
            >
              <div class="pointer-events-auto relative">
                <ProjectCard project={project} />
              </div>
            </div>
          ))
        }
      </div>
    </div>
  </div>
</section>

<script>
  import gsap from 'gsap';
  import { normalizeTechArray } from '@/lib/normalizeTech';

  // --- LÓGICA DE FILTRADO ---
  let filterTimeline: gsap.core.Timeline | null = null;

  function handleFilterChange(event: Event) {
    const customEvent = event as CustomEvent;
    const { activeTechs } = customEvent.detail as { activeTechs: string[] };
    const cards = document.querySelectorAll('[data-project-slug][data-tech]');

    if (filterTimeline) filterTimeline.kill();

    filterTimeline = gsap.timeline({
      defaults: { duration: 0.15, ease: 'power2.inOut' },
    });

    const cardsToShow: HTMLElement[] = [];
    const cardsToHide: HTMLElement[] = [];

    cards.forEach((card) => {
      const el = card as HTMLElement;
      const techStr = el.getAttribute('data-tech');
      let show = true;

      if (techStr && activeTechs && activeTechs.length > 0) {
        try {
          const projectTechs = JSON.parse(techStr);
          const normalizedProjectTechs = normalizeTechArray(projectTechs);
          show = activeTechs.every((tech: string) =>
            normalizedProjectTechs.includes(tech)
          );
        } catch (e) {
          show = true;
        }
      }
      if (show) cardsToShow.push(el);
      else cardsToHide.push(el);
    });

    cardsToHide.forEach((el) => {
      filterTimeline!.to(
        el,
        {
          opacity: 0,
          scale: 0.92,
          duration: 0.12,
          onComplete: () => {
            el.classList.add('hidden');
            el.style.display = 'none';
          },
        },
        0
      );
    });
    cardsToShow.forEach((el) => {
      el.classList.remove('hidden');
      el.style.display = '';
      filterTimeline!.to(el, { opacity: 1, scale: 1, duration: 0.15 }, 0);
    });
  }

  document.addEventListener('filter-changed', handleFilterChange);
  document.addEventListener('astro:before-swap', () => {
    if (filterTimeline) filterTimeline.kill();
  });

  // --- LÓGICA DEL MODAL (BODY FREEZE + NO JUMP FIX) ---
  function initializeModal() {
    const overlay = document.getElementById('project-overlay');
    const overlayBg = document.getElementById('overlay-bg');
    const grid = document.getElementById('projects-grid');

    if (!overlay || !overlayBg || !grid) return;

    let scrollPosition = 0;

    const openProjectModal = (slug: string) => {
      const wrapper = overlay.querySelector(`[data-slug="${slug}"]`);
      if (!wrapper) return;

      // 1. Guardar posición y congelar
      scrollPosition = window.scrollY;
      document.body.style.position = 'fixed';
      document.body.style.top = `-${scrollPosition}px`;
      document.body.style.width = '100%';
      document.body.style.overflowY = 'scroll';

      overlay.classList.remove('pointer-events-none');
      gsap.to(overlay, { opacity: 1, duration: 0.3 });

      wrapper.classList.remove('hidden');
      gsap.fromTo(
        wrapper,
        { scale: 0.95, opacity: 0, y: 20 },
        { scale: 1, opacity: 1, y: 0, duration: 0.4, ease: 'back.out(1.1)' }
      );
    };

    const closeProjectModal = () => {
      const visibleWrapper = overlay.querySelector(
        '.project-detail-wrapper:not(.hidden)'
      );
      if (!visibleWrapper) return;

      gsap.to(visibleWrapper, {
        scale: 0.95,
        opacity: 0,
        y: 20,
        duration: 0.25,
        ease: 'power2.in',
        onComplete: () => {
          visibleWrapper.classList.add('hidden');
          gsap.to(overlay, {
            opacity: 0,
            duration: 0.2,
            onComplete: () => {
              overlay.classList.add('pointer-events-none');

              // --- FIX DEL SALTO (JUMP) ---
              // 1. Desactivar scroll suave globalmente
              const html = document.documentElement;
              const originalScrollBehavior = html.style.scrollBehavior;
              html.style.scrollBehavior = 'auto';

              // 2. Restaurar propiedades del body
              document.body.style.position = '';
              document.body.style.top = '';
              document.body.style.width = '';
              document.body.style.overflowY = '';

              // 3. Restaurar posición instantáneamente (sin animación)
              window.scrollTo(0, scrollPosition);

              // 4. Reactivar scroll suave (en el siguiente frame)
              requestAnimationFrame(() => {
                html.style.scrollBehavior = originalScrollBehavior;
              });
            },
          });
        },
      });
    };

    grid.addEventListener('click', (e) => {
      const card = (e.target as HTMLElement).closest('[data-project-slug]');
      if (card) openProjectModal(card.getAttribute('data-project-slug')!);
    });

    overlay.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (
        target.id === 'overlay-bg' ||
        target.classList.contains('overflow-y-auto') ||
        target.classList.contains('min-h-full')
      ) {
        closeProjectModal();
      }
      if (target.closest('.close-modal-btn')) {
        closeProjectModal();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeProjectModal();
    });
  }

  initializeModal();
</script>

<style>
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  #projects-grid {
    display: grid !important;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)) !important;
    gap: 2rem !important;
  }
  @media (max-width: 767px) {
    #projects-grid {
      grid-template-columns: repeat(1, 1fr) !important;
    }
  }
  @media (min-width: 768px) {
    #projects-grid {
      grid-template-columns: repeat(2, 1fr) !important;
    }
  }
  .project-thumbnail-trigger.hidden {
    display: none !important;
  }
</style>
