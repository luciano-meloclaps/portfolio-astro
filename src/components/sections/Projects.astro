---
// src/components/sections/Projects.astro
import { getCollection } from 'astro:content';
import ProjectThumbnailCard from '../modules/ProjectThumbnailCard.astro';
import ProjectCard from '../modules/ProjectCard.astro';
import SectionTitle from '@/components/ui/SectionTitle.astro';
import FilterBar from '@/components/ui/FilterBar.astro';
// ⚡ IMPORTAMOS TU BOTÓN
import Button from '@/components/ui/Button.astro';
import { IconChevronDown } from '@tabler/icons-react';

import { PROJECT_FILTERS } from '@/config/filter-list';
import { normalizeTechName } from '@/lib/normalizeTech';

const allProjects = await getCollection('projects');
allProjects.sort(
  (a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf()
);

const usedTechsInProjects = new Set(
  allProjects
    .flatMap((p) => p.data.techStack ?? [])
    .filter((t): t is string => typeof t === 'string' && t.length > 0)
    .map((t) => normalizeTechName(t))
);

const activeFilters = PROJECT_FILTERS.filter((tech) =>
  usedTechsInProjects.has(tech)
);

const INITIAL_LIMIT = 4;
---

<section id="projects" class="relative py-24 md:py-32">
  <div class="container-narrow projects-section-content space-y-16">
    <div class="flex w-full flex-col items-center justify-center">
      <SectionTitle
        title="Proyectos"
        subtitle="Código en funcionamiento. Soluciones reales a problemas reales."
        class="items-center text-center"
      />
    </div>

    {
      activeFilters.length > 0 && (
        <div class="filter-bar-wrapper">
          <FilterBar availableTechs={activeFilters} sectionId="projects" />
        </div>
      )
    }

    <div id="projects-grid" class="grid grid-cols-1 gap-8 md:grid-cols-2">
      {
        allProjects.map((project, index) => {
          const isHiddenInitially = index >= INITIAL_LIMIT;
          const techStackJson = JSON.stringify(project.data.techStack || []);

          return (
            <div
              class={`project-item-wrapper transition-all duration-300 ${isHiddenInitially ? 'hidden-by-pagination hidden' : ''}`}
              data-index={index}
              data-project-slug={project.slug}
              data-tech={techStackJson}
            >
              <ProjectThumbnailCard project={project} index={index} />
            </div>
          );
        })
      }
    </div>

    <!-- ⚡ BOTÓN VER MÁS (REDISEÑADO) -->
    {
      allProjects.length > INITIAL_LIMIT && (
        <div
          class="mt-12 flex justify-center"
          id="load-more-projects-container"
        >
          <div id="load-more-projects-trigger">
            <Button variant="secondary" class="group min-w-[200px]">
              Ver Más Proyectos
              <IconChevronDown className="w-4 h-4 transition-transform duration-300 group-hover:translate-y-1" />
            </Button>
          </div>
        </div>
      )
    }
  </div>

  <!-- OVERLAY MODAL (Sin cambios) -->
  <div
    id="project-overlay"
    class="pointer-events-none fixed inset-0 z-[9999] opacity-0"
    aria-hidden="true"
  >
    <div
      class="absolute inset-0 bg-background/95 backdrop-blur-sm transition-opacity duration-300"
      id="overlay-bg"
    >
    </div>

    <div
      class="no-scrollbar fixed inset-0 overflow-y-auto overscroll-contain"
      style="-webkit-overflow-scrolling: touch;"
    >
      <div
        class="flex min-h-full items-center justify-center p-4 text-center sm:p-6"
      >
        {
          allProjects.map((project, index) => (
            <div
              class="project-detail-wrapper relative hidden w-full max-w-5xl text-left"
              data-slug={project.slug}
            >
              <div class="pointer-events-auto relative">
                <ProjectCard project={project} index={index} />
              </div>
            </div>
          ))
        }
      </div>
    </div>
  </div>
</section>

<script>
  import gsap from 'gsap';
  import { normalizeTechArray } from '@/lib/normalizeTech';

  let filterTimeline: gsap.core.Timeline | null = null;

  // Usamos el ID del wrapper del botón para el evento click
  const loadMoreBtn = document.getElementById('load-more-projects-trigger');
  const loadMoreContainer = document.getElementById(
    'load-more-projects-container'
  );
  const STEP = 4;

  // --- LÓGICA DE FILTRADO (Optimizada en velocidad) ---
  function handleFilterChange(event: Event) {
    const customEvent = event as CustomEvent;
    const { activeTechs } = customEvent.detail as { activeTechs: string[] };
    const wrappers = document.querySelectorAll('.project-item-wrapper');

    if (filterTimeline) filterTimeline.kill();

    filterTimeline = gsap.timeline({
      defaults: { duration: 0.3, ease: 'power2.out' },
    });

    const wrappersToShow: HTMLElement[] = [];
    const wrappersToHide: HTMLElement[] = [];

    const isFiltering = activeTechs && activeTechs.length > 0;
    if (loadMoreContainer) {
      loadMoreContainer.style.display = isFiltering ? 'none' : '';
      if (!isFiltering) {
        const remaining = document.querySelectorAll(
          '.hidden-by-pagination'
        ).length;
        loadMoreContainer.style.display = remaining > 0 ? '' : 'none';
      }
    }

    wrappers.forEach((wrapper) => {
      const el = wrapper as HTMLElement;
      if (!isFiltering && el.classList.contains('hidden-by-pagination')) {
        wrappersToHide.push(el);
        return;
      }

      const techStr = el.getAttribute('data-tech');
      let show = true;

      if (isFiltering && techStr) {
        try {
          const projectTechs = JSON.parse(techStr);
          const normalizedProjectTechs = normalizeTechArray(projectTechs);
          show = activeTechs.every((tech: string) =>
            normalizedProjectTechs.includes(tech)
          );
        } catch (e) {
          show = true;
        }
      }

      if (show) wrappersToShow.push(el);
      else wrappersToHide.push(el);
    });

    wrappersToHide.forEach((el) => {
      filterTimeline!.to(
        el,
        {
          opacity: 0,
          scale: 0.95, // Menos escala para que sea más sutil
          duration: 0.15,
          onComplete: () => {
            el.classList.add('hidden');
            el.style.display = 'none';
          },
        },
        0
      );
    });

    wrappersToShow.forEach((el) => {
      el.classList.remove('hidden');
      el.style.display = '';
      filterTimeline!.to(el, { opacity: 1, scale: 1, duration: 0.2 }, 0);
    });
  }

  // --- LÓGICA DE PAGINACIÓN (TURBO MODE) ---
  loadMoreBtn?.addEventListener('click', () => {
    const hiddenWrappers = document.querySelectorAll('.hidden-by-pagination');
    let count = 0;

    hiddenWrappers.forEach((wrapper) => {
      if (count < STEP) {
        wrapper.classList.remove('hidden', 'hidden-by-pagination');
        const el = wrapper as HTMLElement;

        // Estado inicial para animación
        el.style.opacity = '0';
        el.style.transform = 'translateY(15px)'; // Menos distancia
        el.style.display = '';

        gsap.to(el, {
          opacity: 1,
          y: 0,
          duration: 0.3,
          ease: 'power2.out',
          delay: count * 0.05,
        });

        count++;
      }
    });

    const remaining = document.querySelectorAll('.hidden-by-pagination').length;
    if (remaining === 0 && loadMoreContainer) {
      gsap.to(loadMoreContainer, {
        opacity: 0,
        height: 0,
        margin: 0,
        duration: 0.3,
        onComplete: () => {
          loadMoreContainer.style.display = 'none';
        },
      });
    }
  });

  document.addEventListener('filter-changed', handleFilterChange);
  document.addEventListener('astro:before-swap', () => {
    if (filterTimeline) filterTimeline.kill();
  });

  function initializeModal() {
    const overlay = document.getElementById('project-overlay');
    const overlayBg = document.getElementById('overlay-bg');
    const grid = document.getElementById('projects-grid');

    if (!overlay || !overlayBg || !grid) return;

    let scrollPosition = 0;

    const openProjectModal = (slug: string) => {
      const wrapper = overlay.querySelector(`[data-slug="${slug}"]`);
      if (!wrapper) return;

      scrollPosition = window.scrollY;
      document.body.style.position = 'fixed';
      document.body.style.top = `-${scrollPosition}px`;
      document.body.style.width = '100%';
      document.body.style.overflowY = 'scroll';

      overlay.classList.remove('pointer-events-none');
      gsap.to(overlay, { opacity: 1, duration: 0.3 });

      wrapper.classList.remove('hidden');
      gsap.fromTo(
        wrapper,
        { scale: 0.95, opacity: 0, y: 20 },
        { scale: 1, opacity: 1, y: 0, duration: 0.4, ease: 'back.out(1.1)' }
      );
    };

    const closeProjectModal = () => {
      const visibleWrapper = overlay.querySelector(
        '.project-detail-wrapper:not(.hidden)'
      );
      if (!visibleWrapper) return;

      gsap.to(visibleWrapper, {
        scale: 0.95,
        opacity: 0,
        y: 20,
        duration: 0.25,
        ease: 'power2.in',
        onComplete: () => {
          visibleWrapper.classList.add('hidden');
          gsap.to(overlay, {
            opacity: 0,
            duration: 0.2,
            onComplete: () => {
              overlay.classList.add('pointer-events-none');
              const html = document.documentElement;
              const originalScrollBehavior = html.style.scrollBehavior;
              html.style.scrollBehavior = 'auto';
              document.body.style.position = '';
              document.body.style.top = '';
              document.body.style.width = '';
              document.body.style.overflowY = '';
              window.scrollTo(0, scrollPosition);
              requestAnimationFrame(() => {
                html.style.scrollBehavior = originalScrollBehavior;
              });
            },
          });
        },
      });
    };

    grid.addEventListener('click', (e) => {
      const cardWrapper = (e.target as HTMLElement).closest(
        '[data-project-slug]'
      );
      if (cardWrapper)
        openProjectModal(cardWrapper.getAttribute('data-project-slug')!);
    });

    overlay.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (target.id === 'overlay-bg' || target.closest('.close-modal-btn')) {
        closeProjectModal();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeProjectModal();
    });
  }

  initializeModal();
</script>
