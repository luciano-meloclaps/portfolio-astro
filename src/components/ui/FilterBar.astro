---
// src/components/ui/FilterBar.astro
import TechChip from '@/components/ui/TechChip.astro';
import { techIconMap } from '@/config/tech-icon-map';
import { normalizeTechName } from '@/lib/normalizeTech';

interface Props {
  availableTechs: string[];
  sectionId?: string;
}

const { availableTechs, sectionId = 'projects' } = Astro.props;
---

<div class="filter-bar-wrapper space-y-4">
  <label
    class="block font-mono text-sm font-light uppercase tracking-normal text-text-secondary"
  >
    Filtrar por:
  </label>

  <div
    id="filter-container"
    class="filter-chips-container flex flex-wrap gap-2 sm:gap-3"
    role="group"
    data-filter-section={sectionId}
  >
    {
      availableTechs.map((tech) => {
        const normalizedTech = normalizeTechName(tech);
        const Icon = techIconMap[normalizedTech] || null;
        const displayLabel = normalizedTech === 'dotnet' ? '.NET' : tech;

        return (
          <TechChip
            Icon={Icon}
            name={normalizedTech}
            label={displayLabel}
            mode="filter"
            data-filter-name={normalizedTech}
            data-filter-label={displayLabel}
            data-filter-active="false"
            aria-pressed="false"
          />
        );
      })
    }
  </div>

  <div
    class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between"
  >
    <span
      id="filter-counter-text"
      class="font-mono text-xs uppercase tracking-wide text-text-secondary"
    >
      Mostrando todos los proyectos
    </span>
    <button
      id="filter-clear-btn"
      class="hidden cursor-pointer font-mono text-xs uppercase tracking-wide text-text-secondary hover:text-text-primary"
    >
      Limpiar filtros
    </button>
  </div>
  <div
    class="bg-border/50 h-px opacity-0 transition-opacity duration-300"
    id="filter-line"
  >
  </div>
</div>

<style>
  .filter-bar-wrapper {
    position: relative;
    z-index: 10;
  }
  #filter-line.active {
    opacity: 1;
    background: linear-gradient(
      90deg,
      transparent,
      var(--color-text-primary),
      transparent
    );
  }
</style>

<script>
  import { normalizeTechName } from '@/lib/normalizeTech';

  function initFilterBar() {
    const container = document.getElementById('filter-container');
    if (!container) return;

    const sectionId = container.getAttribute('data-filter-section');
    const clearBtn = document.getElementById('filter-clear-btn');
    const filterLine = document.getElementById('filter-line');
    const counterText = document.getElementById('filter-counter-text');

    const updateUI = () => {
      // Usamos la clase segura js-filter-chip
      const activeChips = container.querySelectorAll(
        '.js-filter-chip[data-filter-active="true"]'
      );

      if (counterText) {
        if (activeChips.length === 0) {
          counterText.textContent = 'Mostrando todos los proyectos';
          filterLine?.classList.remove('active');
        } else {
          const names = Array.from(activeChips)
            .map((c) => c.getAttribute('data-filter-label')?.toUpperCase())
            .join(', ');
          counterText.textContent = `FILTROS ACTIVOS: ${names}`;
          filterLine?.classList.add('active');
        }
      }

      clearBtn?.classList.toggle('hidden', activeChips.length === 0);

      const activeNames = Array.from(activeChips).map(
        (c) => c.getAttribute('data-filter-name') || ''
      );

      document.dispatchEvent(
        new CustomEvent('filter-changed', {
          detail: { activeTechs: activeNames, section: sectionId },
        })
      );
    };

    container.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      // Buscamos la clase segura
      const chip = target.closest('.js-filter-chip');

      if (!chip) return;

      const isActive = chip.getAttribute('data-filter-active') === 'true';

      if (target.closest('[data-remove-x]')) {
        chip.setAttribute('data-filter-active', 'false');
        chip.setAttribute('aria-pressed', 'false');
      } else {
        chip.setAttribute('data-filter-active', String(!isActive));
        chip.setAttribute('aria-pressed', String(!isActive));
      }

      updateUI();
    });

    clearBtn?.addEventListener('click', () => {
      container.querySelectorAll('.js-filter-chip').forEach((c) => {
        c.setAttribute('data-filter-active', 'false');
        c.setAttribute('aria-pressed', 'false');
      });
      updateUI();
    });
  }

  document.addEventListener('astro:page-load', initFilterBar);
  document.addEventListener('DOMContentLoaded', initFilterBar);
</script>
