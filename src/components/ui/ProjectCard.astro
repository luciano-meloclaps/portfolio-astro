---
// src/components/ui/ProjectCard.astro
// Versión simplificada sin imágenes

import Card from '@/components/ui/Card.astro';
import Button from '@/components/ui/Button.astro';
import ChipTech from '@/components/ui/ChipTech.astro';
import {
  IconPointFilled,
  IconBrandGithub,
  IconWorld,
  IconBrandReact,
  IconBrandAstro,
  IconBrandTypescript,
  IconBrandTailwind,
  IconHexagons,
} from '@tabler/icons-react';
import type { CollectionEntry } from 'astro:content';

// --- MAPA DE ICONOS PARA TECH STACK ---
const techIconMap: Record<string, astroHTML.JSX.Element> = {
  react: IconBrandReact,
  astro: IconBrandAstro,
  typescript: IconBrandTypescript,
  tailwind: IconBrandTailwind,
  dotnet: IconHexagons,
};

// --- CONTRATO DEL COMPONENTE ---
interface Props {
  project: CollectionEntry<'projects'>;
}
const { project } = Astro.props;
const { title, description, keyFeatures, techStack, liveUrl, repoUrl } =
  project.data;
---

<div class="project-card-wrapper group cursor-pointer">
  <Card padding="none" class="relative overflow-hidden">
    <div class="halo-effect"></div>
    <div class="p-6 md:p-8">
      <h3 class="text-h3 font-bold text-text-primary">{title}</h3>
      <p
        class="project-description mt-2 text-base text-text-secondary"
        style="font-weight: 300;"
      >
        {description}
      </p>

      <div class="details-container max-h-0 overflow-hidden">
        <div class="details-content pt-6">
          <div class="border-t border-border pt-6">
            <h4
              class="font-sans text-sm font-bold uppercase tracking-wider text-text-secondary"
            >
              Key Features
            </h4>
            <ul class="mt-4 space-y-3">
              {
                keyFeatures.map((feature) => (
                  <li class="flex items-start gap-x-3">
                    <IconPointFilled className="h-4 w-4 flex-shrink-0 text-text-secondary/50 mt-1" />
                    <span class="text-sm text-text-secondary">{feature}</span>
                  </li>
                ))
              }
            </ul>
          </div>
          <div class="mt-6">
            <h4
              class="font-sans text-sm font-bold uppercase tracking-wider text-text-secondary"
            >
              Tech Stack
            </h4>
            <div class="mt-4 flex flex-wrap gap-2">
              {
                techStack.map((tech) => {
                  const Icon = techIconMap[tech.toLowerCase()];
                  return Icon ? (
                    <ChipTech
                      Icon={Icon}
                      name={tech}
                      className="!px-2 !py-0.5 !text-xs"
                    />
                  ) : null;
                })
              }
            </div>
          </div>
        </div>
      </div>

      <div
        class="mt-8 flex flex-grow flex-col justify-end gap-y-4 md:flex-row md:gap-x-4"
      >
        {
          liveUrl && (
            <Button
              href={liveUrl}
              target="_blank"
              variant="primary"
              className="!w-full !px-4 !py-1.5 !text-xs md:!w-auto"
            >
              <IconWorld className="icon-base" /> Live Demo
            </Button>
          )
        }
        {
          repoUrl && (
            <Button
              href={repoUrl}
              target="_blank"
              variant="secondary"
              className="!w-full !px-4 !py-1.5 !text-xs md:!w-auto"
            >
              <IconBrandGithub className="icon-base" /> Código
            </Button>
          )
        }
      </div>
    </div>
  </Card>
</div>

<!-- El script de GSAP para el despliegue -->
<script>
  import gsap from 'gsap';

  document.querySelectorAll('.project-card-wrapper').forEach((cardWrapper) => {
    const detailsContainer = cardWrapper.querySelector('.details-container');
    const detailsContent = cardWrapper.querySelector('.details-content');
    let isDetailsVisible = false;

    if (!detailsContainer || !detailsContent) return;

    const revealTl = gsap.timeline({ paused: true });
    revealTl.to(detailsContainer, {
      maxHeight: () => detailsContent.scrollHeight,
      duration: 0.8,
      ease: 'power3.inOut',
    });

    cardWrapper.addEventListener('click', (e) => {
      const target = e.target;
      if (target && target.closest('a')) return;

      isDetailsVisible = !isDetailsVisible;
      if (isDetailsVisible) {
        revealTl.play();
      } else {
        revealTl.reverse();
      }
    });
  });
</script>

<!-- Estilos encapsulados para el Halo de Luz -->
<style>
  .halo-effect {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: inherit;
    z-index: 1;
    opacity: 0;
    transition: opacity 0.4s ease-in-out;
    box-shadow:
      inset 0 0 0 1.5px var(--color-glow-border, white),
      0 0 25px 0 var(--color-glow-border, white);
  }
  .group:hover .halo-effect {
    opacity: 1;
  }
</style>
